<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Data Quality — Interactivo</title>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <link rel="preconnect" href="https://fonts.gstatic.com"/>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --ink:#e5e7eb; --accent:#34d399;
    }
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;}
    .wrap{max-width:1280px;margin:24px auto;padding:0 16px;}
    h1{margin:0 0 8px;}
    .muted{color:var(--muted);font-size:14px}
    .filters{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;margin:18px 0;padding:16px;background:#0b1220;border-radius:14px}
    .filters > div{grid-column:span 3}
    .filters label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .filters select,.filters input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #243042;background:#0e172a;color:#e5e7eb}
    .btn{background:var(--accent);color:#062e2a;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .kpis{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin:14px 0}
    .kpi{grid-column:span 3;background:var(--card);border-radius:12px;padding:16px}
    .kpi .big{font-size:30px;font-weight:800}
    .kpi .sub{color:var(--muted);margin-top:6px}
    .cards{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;margin:16px 0}
    .card{grid-column:span 6;background:var(--card);border-radius:14px;padding:14px}
    .card-4{grid-column:span 3}
    .hrow{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .table{background:var(--card);border-radius:14px;padding:12px;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid #1f2937;padding:8px 10px;text-align:left}
    th{color:#cbd5e1;font-weight:600}
    .chip{display:inline-block;background:#0b1220;border:1px solid #203047;color:#93c5fd;border-radius:999px;padding:2px 10px;font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Data Quality — Interactivo</h1>
  <p class="muted">JSON generados por <span class="chip">dq_build_local_report.py</span> en <code>site/data/</code></p>

  <div class="filters">
    <div>
      <label>Agency</label>
      <select id="fAgency"></select>
    </div>
    <div>
      <label>Destination</label>
      <select id="fDest"></select>
    </div>
    <div>
      <label>Condactivación</label>
      <select id="fCond"></select>
    </div>
    <div>
      <label>Días hasta Check-in (min–max)</label>
      <div style="display:flex;gap:6px">
        <input id="fMin" type="number" step="1">
        <input id="fMax" type="number" step="1">
      </div>
    </div>
    <div style="grid-column:span 3">
      <label>Rango de fechas (histórico)</label>
      <div style="display:flex;gap:6px">
        <input id="fFrom" type="date">
        <input id="fTo" type="date">
      </div>
    </div>
    <div style="grid-column:span 2">
      <label>Día de detalle</label>
      <input id="fDay" type="date">
    </div>
    <div style="display:flex;align-items:flex-end">
      <button class="btn" id="apply">Aplicar filtros</button>
    </div>
    <div style="grid-column:span 12">
      <span class="muted">Rango disponible: <span id="rangeText"></span></span>
    </div>
  </div>

  <!-- KPIs -->
  <div class="kpis">
    <div class="kpi"><div class="big" id="k_total">0</div><div class="sub">Registros (rango)</div></div>
    <div class="kpi"><div class="big" id="k_with">0</div><div class="sub">Con email · <span id="k_with_pct">0%</span></div></div>
    <div class="kpi">
      <div class="big" id="k_valid">0</div>
      <div class="sub">Formato válido · <span id="k_valid_pct">0%</span> de con email
        <div class="muted" style="margin-top:4px;font-size:12px" id="k_invalid_break"></div>
      </div>
    </div>
    <div class="kpi"><div class="big" id="k_send">0</div><div class="sub">Enviables (suma diaria) · <span id="k_send_pct">0%</span> del total</div></div>
    <div class="kpi"><div class="big" id="k_global_unique">0</div><div class="sub">Únicos enviables (rango)</div></div>
  </div>

  <h2>Histórico (según filtros)</h2>
  <div class="cards">
    <div class="card">
      <div class="hrow"><strong>Histórico: Total vs Enviables</strong></div>
      <div id="c_hist_tvse"></div>
    </div>
    <div class="card">
      <div class="hrow"><strong>Histórico: Razones DQ (stacked)</strong></div>
      <div id="c_hist_reasons"></div>
    </div>
    <div class="card">
      <div class="hrow"><strong>Top dominios (enviables, mensual)</strong></div>
      <div id="c_hist_top_domains"></div>
    </div>
    <div class="card">
      <div class="hrow"><strong>Resumen diario (tabla)</strong></div>
      <div class="table"><table id="t_daily"></table></div>
    </div>
  </div>

  <h2>Detalle del día <span class="chip" id="dayChip"></span></h2>
  <div class="cards">
    <div class="card">
      <div class="hrow"><strong>Volumen del día (porcentajes)</strong></div>
      <div id="c_day_bars"></div>
    </div>
    <div class="card">
      <div class="hrow"><strong>Razones DQ del día</strong></div>
      <div id="c_day_pie"></div>
    </div>
    <div class="card">
      <div class="hrow"><strong>Top dominios (enviables, % del día)</strong></div>
      <div id="c_day_domains"></div>
    </div>
    <div class="card">
      <div class="hrow"><strong>Correos duplicados (día)</strong></div>
      <div id="c_day_dup_emails"></div>
    </div>
  </div>

  <h3>Duplicados del día (según filtros)</h3>
  <div class="table"><table id="t_dups"></table></div>
</div>

<script>
const fmt = n => n.toLocaleString('es-MX');

let RAW = [], META=null;

// Carga JSON (en GitHub Pages: site/data/…)
async function loadAll() {
  const [hist, meta] = await Promise.all([
    fetch('site/data/historical_rows.json').then(r=>r.json()),
    fetch('site/data/meta.json').then(r=>r.json()),
  ]);
  RAW = hist;
  META = meta;

  // filtros
  fillSelect('fAgency', ['ALL', ...META.agencies]);
  fillSelect('fDest',   ['ALL', ...META.destinations]);
  fillSelect('fCond',   ['ALL', ...META.conds]);
  document.getElementById('fMin').value = META.dias_min;
  document.getElementById('fMax').value = META.dias_max;
  document.getElementById('fFrom').value = META.range_start;
  document.getElementById('fTo').value   = META.range_end;
  document.getElementById('fDay').value  = META.range_end;
  document.getElementById('rangeText').innerText = `${META.range_start} a ${META.range_end}`;

  applyFilters();
}

function fillSelect(id, arr){
  const el = document.getElementById(id);
  el.innerHTML = '';
  for(const v of arr){
    const o = document.createElement('option');
    o.value = v; o.textContent = v;
    el.appendChild(o);
  }
}

function applyFilters(){
  const ag = document.getElementById('fAgency').value;
  const ds = document.getElementById('fDest').value;
  const co = document.getElementById('fCond').value;
  const minD = Number(document.getElementById('fMin').value);
  const maxD = Number(document.getElementById('fMax').value);
  const from = document.getElementById('fFrom').value;
  const to   = document.getElementById('fTo').value;
  const day  = document.getElementById('fDay').value;

  const rows = RAW.filter(r=>{
    const okAg = (ag==='ALL' || (r.agency||'').trim()===ag);
    const okDs = (ds==='ALL' || (r.destination||'').trim()===ds);
    const okCo = (co==='ALL' || (r.condactivacion||'').trim()===co);
    const d = new Date(r.fecha);
    const okRange = (!from || d>=new Date(from)) && (!to || d<=new Date(to));
    const di = Number(r.dias_ant_check_in);
    const okDays = (isNaN(minD) || di>=minD) && (isNaN(maxD) || di<=maxD);
    return okAg && okDs && okCo && okRange && okDays;
  });

  drawKPIs(rows);
  drawHistory(rows);
  drawDayDetail(rows, day);
}

function kpiBreakdown(rows){
  const withEmail = rows.filter(r=>r.has_email);
  const invalid_format = withEmail.filter(r=>!r.valid_format).length;
  const empty = rows.length - withEmail.length;
  const dups  = rows.filter(r=>r.is_duplicate).length;
  return {invalid_format, empty, dups};
}

function drawKPIs(rows){
  // totales
  const total = rows.length;
  const withEmail = rows.filter(r=>r.has_email).length;
  const valid = rows.filter(r=>r.has_email && r.valid_format).length;

  // enviables por día (únicos válidos por día)
  const sendPerDay = {};
  for(const r of rows){
    const key = r.fecha;
    if(!sendPerDay[key]) sendPerDay[key] = new Set();
    if(r.has_email && r.valid_format && !r.is_duplicate){
      // clave por email_domain+ts no existe; usamos email_domain a falta de email sin exponer; aquí basta contar en día
      sendPerDay[key].add((r.email_domain||'') + '|' + (r.Fecha_de_creacion||''));
    }
  }
  const sendableSum = Object.values(sendPerDay).reduce((a,s)=>a+s.size,0);

  // únicos enviables globales (por email_domain + fecha dentro del rango)
  const globalSet = new Set();
  for(const r of rows){
    if(r.has_email && r.valid_format && !r.is_duplicate){
      globalSet.add(r.email_domain + '|' + r.fecha);
    }
  }

  // Pcts
  const pct_with = total? (100*withEmail/total):0;
  const pct_valid_of_with = withEmail? (100*valid/withEmail):0;
  const pct_send_total = total? (100*sendableSum/total):0;

  document.getElementById('k_total').innerText = fmt(total);
  document.getElementById('k_with').innerText  = fmt(withEmail);
  document.getElementById('k_with_pct').innerText = pct_with.toFixed(2) + '%';
  document.getElementById('k_valid').innerText = fmt(valid);
  document.getElementById('k_valid_pct').innerText = pct_valid_of_with.toFixed(2) + '%';
  document.getElementById('k_send').innerText  = fmt(sendableSum);
  document.getElementById('k_send_pct').innerText = pct_send_total.toFixed(2) + '%';
  document.getElementById('k_global_unique').innerText = fmt(globalSet.size);

  const br = kpiBreakdown(rows);
  document.getElementById('k_invalid_break').innerText =
    `No válidos: vacíos ${fmt(br.empty)} · inválidos ${fmt(br.invalid_format)} · duplicados ${fmt(br.dups)}`;
}

function drawHistory(rows){
  // Serie diaria
  const byDay = {};
  for(const r of rows){
    if(!byDay[r.fecha]) byDay[r.fecha] = {total:0, send:0, ok:0, empty:0, invalid:0, dup:0};
    const b = byDay[r.fecha];
    b.total += 1;
    if(r.has_email && r.valid_format && !r.is_duplicate) b.send += 1;
    if(r.dq_reason==='ok') b.ok += 1;
    if(r.dq_reason==='empty') b.empty += 1;
    if(r.dq_reason==='invalid_format') b.invalid += 1;
    if(r.dq_reason==='duplicate') b.dup += 1;
  }
  const days = Object.keys(byDay).sort();
  const total = days.map(d=>byDay[d].total);
  const send  = days.map(d=>byDay[d].send);

  Plotly.newPlot('c_hist_tvse', [
    {x:days,y:total,mode:'lines+markers',name:'Total'},
    {x:days,y:send, mode:'lines+markers',name:'Enviables'}
  ], {margin:{t:20,r:10,l:40,b:60},paper_bgcolor:'#111827',plot_bgcolor:'#111827',font:{color:'#e5e7eb'}});

  Plotly.newPlot('c_hist_reasons', [
    {x:days, y:days.map(d=>byDay[d].ok),     stackgroup:'a', name:'ok'},
    {x:days, y:days.map(d=>byDay[d].empty),  stackgroup:'a', name:'empty'},
    {x:days, y:days.map(d=>byDay[d].invalid),stackgroup:'a', name:'invalid_format'},
    {x:days, y:days.map(d=>byDay[d].dup),    stackgroup:'a', name:'duplicate'}
  ], {margin:{t:20,r:10,l:40,b:60},paper_bgcolor:'#111827',plot_bgcolor:'#111827',font:{color:'#e5e7eb'}});

  // Top dominios enviables (mensual)
  const dom = {};
  for(const r of rows){
    if(r.has_email && r.valid_format && !r.is_duplicate){
      dom[r.email_domain||''] = (dom[r.email_domain||'']||0)+1;
    }
  }
  const top = Object.entries(dom).sort((a,b)=>b[1]-a[1]).slice(0,15);
  Plotly.newPlot('c_hist_top_domains', [{
    x: top.map(t=>t[0]), y: top.map(t=>t[1]), type:'bar'
  }], {margin:{t:20,r:10,l:40,b:80},paper_bgcolor:'#111827',plot_bgcolor:'#111827',font:{color:'#e5e7eb'}});

  // Resumen diario (tabla)
  let html = `
    <thead><tr>
      <th>Fecha</th><th>Total</th><th>Con email</th><th>Válidos</th>
      <th>Únicos</th><th>Duplicados</th><th>% con email</th><th>% válidos / con email</th><th>% enviables / total</th>
    </tr></thead><tbody>`;
  for(const d of days){
    const b = byDay[d];
    const withEmail = b.total - b.empty;
    const valid = withEmail - b.invalid;
    const pct_with = b.total? (100*withEmail/b.total):0;
    const pct_valid_of_with = withEmail? (100*valid/withEmail):0;
    const pct_send_total = b.total? (100*b.send/b.total):0;
    html += `<tr>
      <td>${d}</td><td>${fmt(b.total)}</td><td>${fmt(withEmail)}</td>
      <td>${fmt(valid)}</td><td>${fmt(b.send)}</td><td>${fmt(b.dup)}</td>
      <td>${pct_with.toFixed(2)}%</td><td>${pct_valid_of_with.toFixed(2)}%</td><td>${pct_send_total.toFixed(2)}%</td>
    </tr>`;
  }
  html += `</tbody>`;
  document.getElementById('t_daily').innerHTML = html;
}

function drawDayDetail(rows, day){
  document.getElementById('dayChip').innerText = day || '';
  const sel = rows.filter(r=>r.fecha===day);

  const total = sel.length;
  const withEmail = sel.filter(r=>r.has_email).length;
  const valid = sel.filter(r=>r.has_email && r.valid_format).length;
  const unique = sel.filter(r=>r.has_email && r.valid_format && !r.is_duplicate).length;
  const pct_with = total? 100*withEmail/total:0;
  const pct_valid_of_with = withEmail? 100*valid/withEmail:0;
  const pct_unique_total = total? 100*unique/total:0;

  // Barras (%)
  Plotly.newPlot('c_day_bars', [{
    x:['Total (100%)','Con email (% total)','Válidos (% con email)','Únicos (% total)','Enviables (% total)'],
    y:[100, pct_with, pct_valid_of_with, pct_unique_total, pct_unique_total],
    type:'bar',
    hovertemplate:'%{y:.2f}%<extra></extra>'
  }], {margin:{t:20,r:10,l:40,b:80},paper_bgcolor:'#111827',plot_bgcolor:'#111827',font:{color:'#e5e7eb'}});

  // Pie razones
  const counts = {ok:0,empty:0,invalid_format:0,duplicate:0};
  for(const r of sel){ counts[r.dq_reason] = (counts[r.dq_reason]||0)+1; }
  Plotly.newPlot('c_day_pie', [{
    labels:['ok','empty','invalid_format','duplicate'],
    values:[counts.ok||0,counts.empty||0,counts.invalid_format||0,counts.duplicate||0],
    type:'pie', textinfo:'percent+label'
  }], {margin:{t:20,r:10,l:10,b:10},paper_bgcolor:'#111827',plot_bgcolor:'#111827',font:{color:'#e5e7eb'}});

  // Top dominios (enviables) % del día
  const dmap = {};
  for(const r of sel){
    if(r.has_email && r.valid_format && !r.is_duplicate){
      dmap[r.email_domain||''] = (dmap[r.email_domain||'']||0)+1;
    }
  }
  const top = Object.entries(dmap).sort((a,b)=>b[1]-a[1]).slice(0,12);
  const denom = Math.max(1, unique);
  Plotly.newPlot('c_day_domains', [{
    x: top.map(t=>t[0]),
    y: top.map(t=>100*t[1]/denom),
    type:'bar',
    hovertemplate:'%{y:.2f}%<extra></extra>'
  }], {margin:{t:20,r:10,l:40,b:80},paper_bgcolor:'#111827',plot_bgcolor:'#111827',font:{color:'#e5e7eb'}});

  // Emails duplicados (sin labels fijos; solo hover)
  const dupMap = {};
  for(const r of sel){
    if(r.is_duplicate && r.has_email && r.email_domain){
      const key = (r.Email || '(desconocido)').toLowerCase();
      dupMap[key] = (dupMap[key]||0)+1;
    }
  }
  const dupTop = Object.entries(dupMap).sort((a,b)=>b[1]-a[1]).slice(0,15);
  Plotly.newPlot('c_day_dup_emails', [{
    y: dupTop.map(t=>t[0]).reverse(),
    x: dupTop.map(t=>t[1]).reverse(),
    type:'bar', orientation:'h',
    hovertemplate:'%{x} duplicados<extra></extra>'
  }], {margin:{t:20,r:10,l:200,b:40},paper_bgcolor:'#111827',plot_bgcolor:'#111827',font:{color:'#e5e7eb'}});

  // Tabla de duplicados del día
  const dupRows = sel.filter(r=>r.is_duplicate && r.has_email).map(r=>({
    Email:(r.Email||'').toLowerCase(),
    Dominio:r.email_domain||'',
    Agency:r.agency||'',
    Destination:r.destination||''
  }));
  let html = `<thead><tr><th>Email</th><th>Dominio</th><th>Agency</th><th>Destination</th></tr></thead><tbody>`;
  for(const r of dupRows){
    html += `<tr><td>${r.Email}</td><td>${r.Dominio}</td><td>${r.Agency}</td><td>${r.Destination}</td></tr>`;
  }
  if(!dupRows.length) html += `<tr><td colspan="4" class="muted">Sin duplicados para este día.</td></tr>`;
  html += `</tbody>`;
  document.getElementById('t_dups').innerHTML = html;
}

document.getElementById('apply').addEventListener('click', applyFilters);
loadAll();
</script>
</body>
</html>
